<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>RTESLAB Music Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="assets/ico/favicon.ico">

    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
    <link href="/static/assets/css/bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="/static/assets/js/bootstrap.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script>
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        $(document).ready(update());
        var i=setInterval("update()",10000);
        async function ButtonClick(button){
            var objurl=document.getElementById("url");
            var url=objurl.value;
            objurl.value='';
            //var objaction=document.getElementById("action");
            //var action=objaction.value;
            var action=button.value;

            var data =
                {
                    "URL": url,
                    "ACTION": action
                };
            var dataToSend = JSON.stringify(data);
            $.ajax(
                        {
                            url: '/',
                            type: 'POST',
                            data: dataToSend,
                            success: function () {
                                $("#responsefield").text(String(action)+" Successed");
                            },
                            error: function (){
                                $("#responsefield").text(String(action)+" Faild. Call 911.");
                            }
                        });
                event.preventDefault();
            await sleep(1000);
            update();
        };

        async function update(){
            window.a++;
            $.ajax(
                    {
                        url: '/retstate',
                        type: 'GET',
                        success: function (jsonResponse) {
                            console.log(jsonResponse);
                            /*
                            {
                                "MusicInfoDict": 
                                {"https://www.youtube.com/watch?v=IJnPC1HAQ5Q": 
                                    {"Title": "【MAD】milet -《Prover》fate/grand order - 絕對魔獸戰線巴比倫尼亞 ED2【中日字幕】", 
                                     "Author": "白無月", 
                                     "Length": 244, 
                                     "Image": "http://i.ytimg.com/vi/IJnPC1HAQ5Q/hqdefault.jpg"}}, 
                                "Playlist": ["https://www.youtube.com/watch?v=IJnPC1HAQ5Q"], 
                                "Status": ["Stop", 0], 
                                "NowPlaying": 0
                            }
                            */

                            playlist=jsonResponse["Playlist"];
                       
                            //var playlist=jsonResponse["Playlist"];
                            


                            var size=Object.keys(playlist).length;
                            
                            if (size==0){
                                var state="Stop";
                                var table=document.getElementById("musiclist");
                                var rowcount=table.rows.length;
                                console.log(rowcount);
                                while (rowcount!=0){
                                    rowcount--;
                                    table.deleteRow(0);
                                }
                            }
                            else{
                                var nowplay=jsonResponse["NowPlaying"];
                                var info=jsonResponse["MusicInfoDict"];
                                var state=jsonResponse["Status"][0];
                                var repeat=jsonResponse["Status"][1];
                                var nowplayURL=playlist[nowplay];
                                var table=document.getElementById("musiclist");
                                var rowcount=table.rows.length;
                                
                                while (rowcount!=0){
                                    rowcount--;
                                    table.deleteRow(0);
                                }
                                while(size!=0){
                                    size--;
                                    table.insertRow();
                                }
                                

                                var rowcount=table.rows.length;
                                for (var i=0,rowcount;row=table.rows[i];i++){
                                    var imgcol=row.insertCell(0);
                                    var txtcol=row.insertCell(1);
                                    var imageURL=info[playlist[i]]["Image"];
                                    var title=info[playlist[i]]["Title"];
                                    var lengths=info[playlist[i]]["Length"];
                                    var length=Math.floor(lengths/60)+'"'+lengths%60;
                                    imgcol.innerHTML='<img src="'+imageURL+'"></img>';
                                    txtcol.innerHTML='<h5>'+title+'</h>'+'<p>Length: '+length+'</p>';
                                }
                                
                            }
                            
                            $("#nowplaystate").text(state);
                            if (state=="Playing"){
                                
                                if(repeat==1){
                                    $("#nowplayrepeat").text("  Repeat On");
                                }
                                else{
                                    $("#nowplayrepeat").text("  Repeat Off");
                                }

                                var nowplayImage=info[nowplayURL]["Image"]
                                var nowplayTitle=info[nowplayURL]["Title"];
                                var nowplayAuthor=info[nowplayURL]["Author"];
                                var nowplayLength=info[nowplayURL]["Length"];
                                var min=Math.floor(nowplayLength/60);
                                var sec=nowplayLength%60;
                                
                                document.getElementById("nowplayimage").src=nowplayImage;
                                $("#nowplaytitle").text(nowplayTitle);
                                $("#nowplayauthor").text(nowplayAuthor);
                                $("#nowplaylength").text(min+" Minutes "+sec+" Seconds");

                            }
                            else if (state=="Stop"){
                                document.getElementById("nowplayimage").src="/static/assets/img/waiting.gif";
                                $("#nowplayrepeat").text("");
                                $("#nowplaytitle").text("");
                                $("#nowplayauthor").text("");
                                $("#nowplaylength").text("")
                            }
                            
                        }
                    });
            }
        
    </script>

    <style>
        html {
            font: normal 13px "HelveticaNeue-Light", Helvetica, Georgia, sans-serif;
        }

        body {
            font: normal 12px;
            font-family: DFKai-sb;
            background: url(static/assets/img/graphy.png);
            background-repeat: repeat;
        }
                
    </style>

</head>


<body id="bootstrap-js">
    
    <div class="container well">
        <div class="row">
            <div class="col-8">
                <input id="url" type="text" class="form-control input-lg" placeholder="Enter Youtube URL Here" style="height:32px">
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Append" onclick="ButtonClick(this)">Append</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Insert" onclick="ButtonClick(this)">Insert</button>
            </div>
        </div>
            
        <div class="row">
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Play" onclick="ButtonClick(this)">Play</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Pause" onclick="ButtonClick(this)">Pause</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Resume" onclick="ButtonClick(this)">Resume</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Stop" onclick="ButtonClick(this)">Stop</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Next" onclick="ButtonClick(this)">Next</button>
            </div>
            <div class="col">    
                <button id="action" class="btn btn-primary btn-block" value="Pre" onclick="ButtonClick(this)">Pre</button>
            </div>
            <div class="col">
                <button id="action" class="btn btn-primary btn-block" value="Repeat" onclick="ButtonClick(this)">Repeat</button>
            </div>
            <div class="col">    
                <button id="action" class="btn btn-primary btn-block" value="Clean" onclick="ButtonClick(this)">Claen</button>
            </div>
        </div>
                


        
    </div>
    <div class="container">
        <div class="row">
            <div class="col-4 well">
                <div class="container" id="musiclistcont">
                    <table id="musiclist"></table>
                </div>
            </div>
            <div class="col">
                <img id="nowplayimage" class="img-fluid"></img>
                <h3 style="font-weight: bolder;">State: <span id="nowplaystate" ></span><span id="nowplayrepeat"></span></h3>
                <h3 style="font-weight: bolder;">Now Playing:</h3>
                <h2 id="nowplaytitle" style="font-weight: bolder;"></h2>
                <h3 style="font-weight: bolder;">Author:</h3>
                <h2 id="nowplayauthor" style="font-weight: bolder;"></h2>
                <h3 style="font-weight: bolder;">Length:</h3>
                <h2 id="nowplaylength" style="font-weight: bolder;"></h2>
            </div>
        </div>
        
    </div>
</body>
</html>
